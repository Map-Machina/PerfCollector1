version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: performancedata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  perfapi:
    build:
      context: .
      target: perfapi
    ports:
      - "8080:8080"
    environment:
      PERFAPI_LISTEN: ":8080"
      PERFAPI_DB_URI: "user=postgres password=postgres dbname=performancedata host=postgres sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # perfprocessord would typically run on a separate machine
  # This is provided for local development/testing
  perfprocessord:
    build:
      context: .
      target: perfprocessord
    ports:
      - "2222:2222"
    volumes:
      - ./config:/root/.perfprocessord
      - ./data:/root/.perfprocessord/data
    environment:
      # Configure via config file or command line arguments
      PERFPROCESSORD_DB: postgres
      PERFPROCESSORD_DB_URI: "user=postgres password=postgres dbname=performancedata host=postgres sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - full  # Only start with: docker compose --profile full up

volumes:
  postgres_data:
